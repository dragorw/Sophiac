name: .NET Core Desktop

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: windows-latest
    
    env:
      SOLUTION_PATH: Sophiac.sln
      UI_PROJECT_PATH: src/Sophiac.UI/Sophiac.UI.csproj
      PUBLISH_DIR: ./publish
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 9.0.x

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    - name: Build
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore --framework net9.0-windows10.0.19041.0

    - name: Publish
      run: |
          dotnet publish ${{ env.UI_PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            --output ${{ env.PUBLISH_DIR }} \
            --framework net9.0-windows10.0.19041.0 \
            --p:PublishSingleFile=true /p:PublishReadyToRun=false
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-latest-app
        path: ${{ env.PUBLISH_DIR }}/*
  release:
    needs: [build]
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./artifacts

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-2.1
          release_name: Release 2.1
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/windows-latest-app/Sophiac.UI.exe
          asset_name: Sophiac-2.1.exe
          asset_content_type: application/octet-stream
